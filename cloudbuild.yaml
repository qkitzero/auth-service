steps:
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "us-central1-docker.pkg.dev/$PROJECT_ID/auth-service/$COMMIT_SHA",
        "-f",
        "./build/auth/Dockerfile",
        ".",
      ]

  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "us-central1-docker.pkg.dev/$PROJECT_ID/auth-service/$COMMIT_SHA",
      ]

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud secrets versions access latest --secret=auth-service-env-file > .env
        gcloud run deploy auth-service \
          --image=us-central1-docker.pkg.dev/$PROJECT_ID/auth-service/$COMMIT_SHA \
          --region=us-central1 \
          --platform=managed \
          --env-vars-file=.env

  # - name: "gcr.io/cloud-builders/docker"
  #   args:
  #     [
  #       "build",
  #       "-t",
  #       "us-central1-docker.pkg.dev/$PROJECT_ID/auth-service-gateway/$COMMIT_SHA",
  #       "-f",
  #       "./build/gateway/Dockerfile",
  #       ".",
  #     ]

  # - name: "gcr.io/cloud-builders/docker"
  #   args:
  #     [
  #       "push",
  #       "us-central1-docker.pkg.dev/$PROJECT_ID/auth-service-gateway/$COMMIT_SHA",
  #     ]

  # - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
  #   entrypoint: gcloud
  #   args:
  #     [
  #       "run",
  #       "deploy",
  #       "auth-service-gateway",
  #       "--image",
  #       "us-central1-docker.pkg.dev/$PROJECT_ID/auth-service-gateway/$COMMIT_SHA",
  #       "--region",
  #       "us-central1",
  #       "--update-secrets",
  #       "ENV=AUTH_SERVICE_ENV:latest,SERVER_HOST=AUTH_SERVICE_SERVER_HOST:latest,SERVER_PORT=AUTH_SERVICE_SERVER_PORT:latest",
  #     ]

images:
  - "us-central1-docker.pkg.dev/$PROJECT_ID/auth-service/$COMMIT_SHA"
  # - "us-central1-docker.pkg.dev/$PROJECT_ID/auth-service-gateway/$COMMIT_SHA"

options:
  logging: CLOUD_LOGGING_ONLY
